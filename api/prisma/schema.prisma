datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  PATIENT
  DOCTOR
  ADMIN
}

enum DoctorVerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AppointmentStatus {
  PENDING_PAYMENT
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum AppointmentType {
  SCHEDULED
  ON_DEMAND
}

enum PaymentProvider {
  STRIPE
  CHAPA
}

enum PaymentStatus {
  INITIATED
  SUCCEEDED
  FAILED
  REFUNDED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
}

model User {
  id           String          @id @default(cuid())
  email        String          @unique
  passwordHash String
  role         UserRole
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  patientProfile PatientProfile?
  doctorProfile  DoctorProfile?
}

model PatientProfile {
  id             String        @id @default(cuid())
  user           User          @relation(fields: [userId], references: [id])
  userId         String        @unique
  fullName       String
  phone          String?
  dateOfBirth    DateTime?
  medicalHistory String?

  appointments   Appointment[] @relation("PatientAppointments")
}

model DoctorProfile {
  id                   String              @id @default(cuid())
  user                 User                @relation(fields: [userId], references: [id])
  userId               String              @unique
  fullName             String
  phone                String?
  specialties          String
  bio                  String?
  verificationStatus   DoctorVerificationStatus @default(PENDING)
  rejectionReason      String?
  consultationFeeCents Int                 @default(0)
  currency             String              @default("ETB")

  documents         DoctorDocument[]
  availabilitySlots AvailabilitySlot[]
  appointments      Appointment[]     @relation("DoctorAppointments")
  payouts           Payout[]
}

model DoctorDocument {
  id         String        @id @default(cuid())
  doctor     DoctorProfile @relation(fields: [doctorId], references: [id])
  doctorId   String
  type       String
  fileUrl    String
  uploadedAt DateTime      @default(now())
}

model AvailabilitySlot {
  id          String        @id @default(cuid())
  doctor      DoctorProfile @relation(fields: [doctorId], references: [id])
  doctorId    String
  start       DateTime
  end         DateTime
  isRecurring Boolean       @default(false)
}

model Appointment {
  id          String            @id @default(cuid())
  doctor      DoctorProfile     @relation("DoctorAppointments", fields: [doctorId], references: [id])
  doctorId    String
  patient     PatientProfile    @relation("PatientAppointments", fields: [patientId], references: [id])
  patientId   String
  type        AppointmentType
  status      AppointmentStatus @default(PENDING_PAYMENT)
  scheduledAt DateTime
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  notes       String?

  payment     Payment?
}

model Payment {
  id            String          @id @default(cuid())
  appointment   Appointment     @relation(fields: [appointmentId], references: [id])
  appointmentId String          @unique
  provider      PaymentProvider
  status        PaymentStatus   @default(INITIATED)
  amountCents   Int
  currency      String          @default("ETB")
  externalId    String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

model Payout {
  id          String        @id @default(cuid())
  doctor      DoctorProfile @relation(fields: [doctorId], references: [id])
  doctorId    String
  amountCents Int
  currency    String        @default("ETB")
  status      PayoutStatus  @default(PENDING)
  createdAt   DateTime      @default(now())
  processedAt DateTime?
}
